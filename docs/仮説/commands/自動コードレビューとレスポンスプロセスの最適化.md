# 自動コードレビューとレスポンスプロセスの最適化

## 仮説の概要
人間を介さない自動コードレビューシステムを構築し、開発ルールに沿った品質を保ちながら、レビューへの対応を効率化する。Claude Code Actionによる自動レビューとreply-reviewコマンドの連携を最適化することで、品質と効率の両立を実現する。

## 現状の課題

### 1. 自動レビューの品質問題
- **オーバーテスト**: 過剰なテスト要求による開発速度の低下
- **ルール適用の不一致**: プロジェクト固有のルールが反映されない
- **コンテキスト理解不足**: 変更の意図を理解せずに機械的なレビュー

### 2. レビュー対応プロセスの問題
- **GraphQLクエリーの失敗**: リゾルブ状態確認が頻繁に失敗
- **返信忘れ**: 長文指示による認識ミス
- **Git操作の複雑性**: 複数のAPIとツールの組み合わせ

### 3. 効率性の問題
- **手動介入の必要性**: 自動化が不完全で人間の確認が必要
- **反復作業**: 同じようなレビューコメントへの対応の繰り返し

## プロンプトの書き方提案

### 1. コードレビュー基準の明確化

#### .github/claude-review-rules.yml
```yaml
review_rules:
  testing:
    # オーバーテストを防ぐ
    - avoid: "すべてのメソッドにテストを要求"
    - prefer: "ビジネスロジックとエッジケースのテスト"
    
  structure:
    # プロジェクト固有のルール
    - enforce: "hooks/は副作用を含まない"
    - enforce: "components/は表示ロジックのみ"
    
  context:
    # 変更意図の理解
    - check_pr_description: true
    - check_related_issues: true
```

### 2. サブエージェント構成

#### git-operations エージェント
```markdown
---
name: git-operations
description: Use PROACTIVELY for all Git and GitHub API operations
tools: Bash, mcp__github__*
---

Git操作とGitHub APIの専門家：
- GraphQL/REST APIの使い分け
- エラーハンドリングとリトライ
- リゾルブ状態の確実な管理
```

#### review-responder エージェント
```markdown
---
name: review-responder
description: MUST BE USED for PR review comment responses
tools: Read, Edit, mcp__github__get_pull_request_comments
---

レビューコメント対応の専門家：
- 各コメントへの確実な返信
- 修正内容の明確な説明
- リゾルブ状態の追跡
```

### 3. 改善されたワークフロー

```mermaid
graph TD
    A[PR作成] --> B[Claude Code Action<br/>自動レビュー]
    B --> C{レビューコメント}
    C -->|あり| D[/reply-review 実行]
    D --> E[git-operations<br/>エージェント]
    D --> F[review-responder<br/>エージェント]
    E --> G[API操作]
    F --> H[修正・返信]
    G --> I[マージ]
    H --> I
```

## カスタムコマンドの活用案

### 簡略化されたreply-reviewコマンド

```markdown
---
description: レビューコメントへの自動対応
argument-hint: <owner> <repo> <pull_number>
---

# レビューコメント対応

以下のサブエージェントを使用して対応：
1. git-operations: コメント取得とAPI操作
2. review-responder: 修正と返信

完了後、自動でプッシュしてください。
```

### GraphQL回避策

```bash
# GraphQLの代わりにGitHub CLIを活用
gh pr view --json reviews,comments --jq '.reviews[].state'
gh pr review --comment --body "対応完了"
```

## フックの設定例

### pre-review フック
```bash
#!/bin/bash
# レビュー前にプロジェクト固有ルールをロード
export REVIEW_RULES=$(cat .github/claude-review-rules.yml)
```

## 期待される効果

### 1. レビュー品質の向上
- **適切な粒度**: オーバーテストの防止
- **一貫性**: プロジェクトルールの遵守
- **文脈理解**: PR意図を考慮したレビュー

### 2. 対応効率の改善
- **API成功率**: 90%以上（現状50%程度）
- **返信完了率**: 100%（サブエージェントによる保証）
- **処理時間**: 50%削減

### 3. 開発体験の向上
- **自動化率**: 80%以上のレビューを自動処理
- **手戻り削減**: 適切なレビューによる品質向上
- **ストレス軽減**: 機械的な作業からの解放

## 検証すべき項目

### 1. 技術的検証
- GitHub CLIとGraphQLのパフォーマンス比較
- サブエージェントのAPI権限
- エラーリトライの実装

### 2. 品質検証
- レビューコメントの適切性評価
- 修正漏れの発生率
- false positive/negativeの測定

### 3. 効率性検証
- end-to-endの処理時間
- 人間介入の必要頻度
- 自動化可能な範囲

## メモ

### 段階的導入計画
1. **Phase 1**: git-operationsエージェントの実装
2. **Phase 2**: review-responderエージェントの追加
3. **Phase 3**: ルールベースレビューの高度化
4. **Phase 4**: 機械学習による改善

### リスクと対策
- **過度な自動化**: 重要な変更は人間レビュー必須
- **API制限**: レート制限を考慮した実装
- **セキュリティ**: 機密情報の取り扱い注意

### 将来の拡張
- PR作成時の自動修正提案
- コミット前のプレレビュー
- チーム固有のレビュー基準学習