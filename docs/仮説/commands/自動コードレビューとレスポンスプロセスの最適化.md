# 自動コードレビューとレスポンスプロセスの最適化

## 仮説の概要
人間を介さない自動コードレビューシステムを構築し、開発ルールに沿った品質を保ちながら、レビューへの対応を効率化する。Claude Code Actionによる自動レビューとreply-reviewコマンドの連携を最適化することで、品質と効率の両立を実現する。

## 現状の課題

### 1. 自動レビューの品質問題
- **オーバーテスト**: 過剰なテスト要求による開発速度の低下
- **ルール適用の不一致**: プロジェクト固有のルールが反映されない
- **コンテキスト理解不足**: 変更の意図を理解せずに機械的なレビュー

### 2. レビュー対応プロセスの問題
- **GraphQLクエリーの失敗**: リゾルブ状態確認が頻繁に失敗
- **返信忘れ**: 長文指示による認識ミス
- **Git操作の複雑性**: 複数のAPIとツールの組み合わせ
- **未解決レビューの探索困難**: レビューが反復されると、未解決（unresolved）のインラインレビューを見つけられなくなる

### 3. 効率性の問題
- **手動介入の必要性**: 自動化が不完全で人間の確認が必要
- **反復作業**: 同じようなレビューコメントへの対応の繰り返し

## ワークフローの図解

### 1. 現状のワークフロー（変更前）

```mermaid
graph TD
    A[開発開始] --> B[開発タスク実行]
    
    B --> C[コミット・プッシュ]
    
    C --> D[PR作成]
    
    D --> E[Claude Code Action自動レビュー]
    D --> F[人力レビュー]
    
    E --> G[インラインコメント投稿]
    F --> H[明らかな問題を指摘]
    
    G --> I[開発者が確認]
    H --> I
    
    I --> J[不要なコメントをリゾルブ]
    
    J --> K[reply-review 実行]
    
    K --> L[MCPでコメント取得]
    L --> M[GraphQLでリゾルブ確認]
    M --> N[修正実施]
    N --> O[テスト実行]
    O --> P[各コメントに返信]
    P --> Q[コミット・プッシュ]
    
    Q --> R{CI結果}
    R -->|失敗| S[調整作業]
    R -->|成功| T[完了]
    S --> K
```

### 2. 改善予定のワークフロー

```mermaid
graph TD
    A[開発開始] --> B[開発タスク実行]
    
    B --> C[コミット・プッシュ]
    
    C --> D[PR作成]
    
    D --> E[Claude Code Actionルールベースレビュー]
    
    E --> F[インラインコメント]
    
    F --> G[reply-review簡略版]
    
    G --> H[review-readerエージェント]
    
    H --> I[コメント分析と分類]
    
    I --> J[フレームワーク専門エージェント]
    I --> K[git-operationsエージェント]
    I --> L[review-responderエージェント]
    
    J --> M[修正実装]
    K --> N[Git操作 add commit push]
    L --> O[レビューへの返信]
    
    M --> P[統合処理]
    N --> P
    O --> P
    
    P --> Q[プッシュ]
    
    Q --> R{CI結果}
    R -->|成功| S[完了]
    R -->|失敗| T[別途対応]
```

## 改善に必要な要素

### 削除する要素

#### カスタムコマンド（reply-review）から削除
- GraphQLクエリーによるリゾルブ状態確認処理
- 110行に及ぶ詳細な指示文
- 複雑なMCP/API連携の直接記述

### 追加する要素

#### 新規サブエージェント
1. **git-operations エージェント**
   - Git操作（add, commit, push等）の専門化
   - エラーハンドリングとリトライの実装
   - ブランチ操作とマージ処理

2. **review-reader エージェント**
   - レビューコメントの読み取りと分析
   - 指摘内容の分類と優先度判定
   - 他エージェントへの情報引き継ぎ

3. **review-responder エージェント**
   - レビューコメントへの返信に特化
   - GitHub APIを使用したコメント投稿
   - 丁寧で専門的な返信作成

4. **フレームワーク専門エージェント**（実装時に追加）
   - Hono、Next.js等の専門知識
   - review-readerの分析結果を受けて実装

#### カスタムコマンドの簡略化
- reply-reviewコマンドを10行程度に圧縮
- サブエージェントへの処理委譲を明記
- 引数の受け渡しのみに専念

## 実装ファイル

### 更新されたコマンド
- [/commands/reply-review-v2.md](/commands/reply-review-v2.md) - サブエージェントを活用した簡略化版

### サブエージェント定義
- [/agents/git-operations.md](/agents/git-operations.md) - Git操作専門エージェント
- [/agents/review-reader.md](/agents/review-reader.md) - レビュー読み取り専門エージェント
- [/agents/review-responder.md](/agents/review-responder.md) - レビュー返信専門エージェント

## 実装上の工夫

### リフォーカス文の追加
各エージェントの末尾に「リフォーカス」セクションを追加し、以下の効果を狙う：
- **無関心の谷の回避**: 長いプロンプトでも最後に核心的な役割を再確認
- **役割の明確化**: やること・やらないことを簡潔に整理
- **成功基準の提示**: 明確なゴールを設定

### エージェント間の明確な依存関係
reply-review-v2.mdで各エージェントの入力・処理・出力を明文化：
- データフローの可視化
- エラー時の影響範囲の限定
- 独立したテストとデバッグが可能